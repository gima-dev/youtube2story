<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Youtube2story</title>
  <script src="https://telegram.org/js/telegram-web-app.js?59"></script>
</head>
<body>
  <div style="padding:12px;background:#f3f8ff;border:1px solid #cfe3ff;border-radius:8px;margin-bottom:12px">
    <strong>Youtube2story</strong>
    <div style="color:#4a5a6a;margin-top:6px">Проверяем возможность публикации в Stories.</div>
  </div>
  <div id="status" style="padding:12px;border-radius:8px;background:#f6f6f6;color:#333">Проверка прав публикации...</div>
  <div id="hint" style="margin-top:10px;color:#666;font-size:14px"></div>
  <script>
    (function(){
      function qs(key){
        const params = new URLSearchParams(window.location.search);
        return params.get(key);
      }
      const sourceUrl = qs('url') || null;
      const statusEl = document.getElementById('status');
      const hintEl = document.getElementById('hint');

      function setStatus(text, hint){
        statusEl.innerText = text;
        hintEl.innerText = hint || '';
      }

      try{
        const inTelegram = !!(window.Telegram && Telegram.WebApp);
        if(!sourceUrl){
          setStatus('Не найдена ссылка на YouTube.', 'Вернитесь в чат бота и отправьте ссылку заново.');
          return;
        }

        if(!inTelegram){
          setStatus('Откройте мини-приложение внутри Telegram.', 'Нажмите кнопку Web App в чате бота.');
          return;
        }

        if(typeof Telegram.WebApp.ready === 'function'){
          try{ Telegram.WebApp.ready(); }catch(e){}
        }

        const canShare = typeof Telegram.WebApp.shareToStory === 'function';
        if(!canShare){
          setStatus('Ваш аккаунт не поддерживает публикацию историй.', 'Нельзя опубликовать из WebApp.');
          return;
        }

        setStatus('Права подтверждены.', 'Запускаем обработку видео...');

        fetch('/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: sourceUrl })
        })
          .then(res => res.json().then(data => ({ ok: res.ok, data })))
          .then(({ ok, data }) => {
            if(!ok || (data && data.error)){
              const msg = (data && data.error) ? String(data.error) : 'Сервер вернул ошибку.';
              setStatus('Не удалось запустить обработку.', msg);
              return;
            }

            if(data && data.processed_url){
              const processed = data.processed_url;
              try{
                Telegram.WebApp.shareToStory({ url: processed });
                setStatus('Открываем редактор историй...', 'Если редактор не открылся, попробуйте еще раз.');
              }catch(e){
                setStatus('Не удалось открыть редактор.', e.message || 'Ошибка вызова shareToStory.');
              }
              return;
            }

            const jobId = data && (data.job_id || data.id);
            if(jobId){
              setStatus('Видео обрабатывается.', 'Откроем редактор, как только видео будет готово.');
              window.location.href = '/publish?job_id=' + encodeURIComponent(jobId);
              return;
            }

            setStatus('Неожиданный ответ сервера.', 'Попробуйте еще раз.');
          })
          .catch(err => {
            setStatus('Ошибка сети.', err && err.message ? err.message : 'Не удалось связаться с сервером.');
          });
      }catch(e){
        setStatus('Ошибка проверки.', 'Попробуйте снова.');
      }
    })();
  </script>
</body>
</html>
