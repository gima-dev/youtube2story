<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Youtube2story</title>
  <script src="https://telegram.org/js/telegram-web-app.js?59"></script>
  <style>
    :root{
      --bg1:#f7f2ea;
      --bg2:#e9f0ff;
      --ink:#1c1c1c;
      --muted:#5a6370;
      --card:#ffffff;
      --accent:#2f7dff;
      --accent-soft:#e7f0ff;
      --warn:#ffb84d;
      --ok:#22c55e;
      --shadow:0 10px 40px rgba(26,38,64,0.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Georgia", "Times New Roman", serif;
      color:var(--ink);
      background:
        radial-gradient(900px 500px at 10% -10%, var(--bg2), transparent 60%),
        radial-gradient(700px 400px at 100% 0%, #fce7c7, transparent 55%),
        linear-gradient(180deg, var(--bg1), #fff);
      min-height:100vh;
      padding:20px 16px 28px;
    }
    .wrap{max-width:560px;margin:0 auto}
    .hero{
      background:var(--card);
      border-radius:var(--radius);
      padding:16px 18px;
      box-shadow:var(--shadow);
      border:1px solid #eef1f6;
      position:relative;
      overflow:hidden;
    }
    .hero::after{
      content:"";
      position:absolute;
      right:-40px;top:-30px;
      width:140px;height:140px;
      background:var(--accent-soft);
      border-radius:50%;
      opacity:0.8;
    }
    .brand{
      font-weight:700;
      letter-spacing:0.2px;
      font-size:20px;
      display:flex;gap:10px;align-items:center;
    }
    .brand-badge{
      width:10px;height:10px;border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 0 6px rgba(47,125,255,0.12);
      flex:0 0 auto;
    }
    .sub{
      color:var(--muted);
      margin-top:6px;
      font-size:14px;
      line-height:1.35;
      font-family:"Helvetica", "Arial", sans-serif;
    }
    .card{
      margin-top:14px;
      background:var(--card);
      border-radius:var(--radius);
      padding:14px 16px;
      border:1px solid #eef1f6;
      box-shadow:var(--shadow);
      font-family:"Helvetica", "Arial", sans-serif;
    }
    .status{
      font-size:16px;
      font-weight:600;
      margin-bottom:6px;
    }
    .hint{color:var(--muted);font-size:13px;line-height:1.35}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      font-size:12px;color:#6d5f3b;
      background:#fff6df;border:1px solid #ffe3a6;
      padding:6px 10px;border-radius:999px;margin-top:12px;
      font-family:"Helvetica", "Arial", sans-serif;
    }
    .dot{
      width:6px;height:6px;border-radius:50%;background:var(--warn);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="brand"><span class="brand-badge"></span>Youtube2story</div>
      <div class="sub">Проверяем возможность публикации в Stories и сразу запускаем обработку.</div>
      <div class="pill"><span class="dot"></span>Открывайте через кнопку в чате бота</div>
    </div>
    <div class="card">
      <div id="status" class="status">Проверка прав публикации...</div>
      <div id="hint" class="hint"></div>
    </div>
  </div>
  <script>
    (function(){
      function qs(key){
        const params = new URLSearchParams(window.location.search);
        return params.get(key);
      }
      const sourceUrl = qs('url') || null;
      const tgUserIdFromQuery = qs('tg_user_id');
      const statusEl = document.getElementById('status');
      const hintEl = document.getElementById('hint');

      function setStatus(text, hint){
        statusEl.innerText = text;
        hintEl.innerText = hint || '';
      }

      function parseTelegramProfile(){
        try{
          if(!(window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user)){
            return {};
          }
          const user = Telegram.WebApp.initDataUnsafe.user || {};
          return {
            tg_user_id: user.id || null,
            username: user.username || null,
            first_name: user.first_name || null,
            last_name: user.last_name || null,
            language_code: user.language_code || null
          };
        }catch(e){
          return {};
        }
      }

      function normalizeTgUserId(value){
        if(value === null || value === undefined) return null;
        const asString = String(value).trim();
        if(!asString) return null;
        const asNumber = Number(asString);
        if(!Number.isFinite(asNumber) || asNumber <= 0) return null;
        return String(Math.trunc(asNumber));
      }

      function startProcessing(tgProfile, canShare){
        setStatus('Права подтверждены.', 'Запускаем обработку видео...');
        const requestPayload = {
          url: sourceUrl,
          can_share: !!canShare,
          tg_user_id: normalizeTgUserId(tgProfile.tg_user_id || tgUserIdFromQuery)
        };
        if(tgProfile.username) requestPayload.username = tgProfile.username;
        if(tgProfile.first_name) requestPayload.first_name = tgProfile.first_name;
        if(tgProfile.last_name) requestPayload.last_name = tgProfile.last_name;
        if(tgProfile.language_code) requestPayload.language_code = tgProfile.language_code;

        fetch('/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestPayload)
        })
          .then(res => res.json().then(data => ({ ok: res.ok, data })))
          .then(({ ok, data }) => {
            if(!ok || (data && data.error)){
              const msg = (data && data.error) ? String(data.error) : 'Сервер вернул ошибку.';
              setStatus('Не удалось запустить обработку.', msg);
              return;
            }

            const jobId = data && (data.job_id || data.id);
            if(jobId){
              setStatus('Видео обрабатывается.', 'Откроем редактор, как только видео будет готово.');
              window.location.href = '/publish?job_id=' + encodeURIComponent(jobId);
              return;
            }

            setStatus('Неожиданный ответ сервера.', 'Попробуйте еще раз.');
          })
          .catch(err => {
            setStatus('Ошибка сети.', err && err.message ? err.message : 'Не удалось связаться с сервером.');
          });
      }

      try{
        const inTelegram = !!(window.Telegram && Telegram.WebApp);
        const tgProfile = parseTelegramProfile();
        const tgUserId = normalizeTgUserId(tgProfile.tg_user_id || tgUserIdFromQuery);
        if(!sourceUrl){
          setStatus('Не найдена ссылка на YouTube.', 'Вернитесь в чат бота и отправьте ссылку заново.');
          return;
        }

        if(!inTelegram){
          setStatus('Откройте мини-приложение внутри Telegram.', 'Нажмите кнопку Web App в чате бота.');
          return;
        }

        if(typeof Telegram.WebApp.ready === 'function'){
          try{ Telegram.WebApp.ready(); }catch(e){}
        }

        function runCapabilityCheck(){
          const canShare = typeof Telegram.WebApp.shareToStory === 'function';
          if(!canShare){
            setStatus('Ваш аккаунт не поддерживает публикацию историй.', 'Нельзя опубликовать из WebApp.');
            return;
          }
          startProcessing(tgProfile, true);
        }

        if(!tgUserId){
          runCapabilityCheck();
          return;
        }

        setStatus('Проверяем сохраненное состояние...', 'Восстанавливаем последнюю сессию публикации.');
        fetch('/user_state?tg_user_id=' + encodeURIComponent(tgUserId) + '&url=' + encodeURIComponent(sourceUrl))
          .then(res => res.json().then(data => ({ ok: res.ok, data })))
          .then(({ ok, data }) => {
            if(!ok || !data || data.ok === false){
              runCapabilityCheck();
              return;
            }

            if(data.job_id && (data.status === 'queued' || data.status === 'processing' || data.status === 'done')){
              setStatus('Найдена активная обработка.', 'Открываем сохраненный прогресс.');
              window.location.href = '/publish?job_id=' + encodeURIComponent(data.job_id);
              return;
            }

            if(data.can_share === true){
              startProcessing(tgProfile, true);
              return;
            }

            runCapabilityCheck();
          })
          .catch(() => runCapabilityCheck());
      }catch(e){
        setStatus('Ошибка проверки.', 'Попробуйте снова.');
      }
    })();
  </script>
</body>
</html>
